import subprocess
import os
import time
import socket   
import requests
import sys

def check_for_new_version(current_version, latest_version):
    if latest_version == "Unknown":
        return False  # Set this to False to indicate no new version
    current_version_parts = [int(part) for part in current_version.split(".")]
    latest_version_parts = [int(part) for part in latest_version.split(".")]

    if current_version_parts < latest_version_parts:
        return True
    return False

def get_latest_version():
    response = requests.get("https://api.github.com/repos/Tsuruta-Kurb/better-prompt/releases/latest")
    response_json = response.json()
    latest_version = response_json.get("tag_name", "Unknown")  # Use "Unknown" if "tag_name" is missing
    return latest_version

def get_connected_wifi_password():
    def get_connected_wifi_profile():
        profile_info = subprocess.check_output(['netsh', 'wlan', 'show', 'interface']).decode('utf-8').split('\n')
        connected_ssid = None
        for line in profile_info:
            if "SSID" in line:
                connected_ssid = line.split(":")[1].strip()
                break
        return connected_ssid
    
    
    connected_ssid = get_connected_wifi_profile()
    if connected_ssid:
        results = subprocess.check_output(['netsh', 'wlan', 'show', 'profile', connected_ssid, 'key=clear']).decode('utf-8').split('\n')
        password = [b.split(":")[1][1:-1] for b in results if "Key Content" in b]
        if password:
            return f"Connected WiFi SSID: {connected_ssid}\nPassword: {password[0]}"
        else:
            return "No password found for the connected WiFi network."
    else:
        return "No WiFi network is currently connected."

def check_internet_speed():
    temp_file_path = os.path.join(os.path.dirname(os.path.abspath(__file__)), 'temp_file')
    download_url = "http://download.thinkbroadband.com/10MB.zip"
    start_time = time.time()
    response = requests.get(download_url)
    with open(temp_file_path, 'wb') as file:
        file.write(response.content)
    end_time = time.time()
    file_size = os.path.getsize(temp_file_path) / 1024 / 1024
    download_speed = file_size / (end_time - start_time)
    os.remove(temp_file_path)
    return download_speed


def get_computer_ip():
    hostname = socket.gethostname()   
    IPAddr = socket.gethostbyname(hostname)
    return f"Your Computer Name is: {hostname}\nYour Computer IP Address is: {IPAddr}"

def main():
    current_version = "1.0"  # Your current version
    latest_version = get_latest_version()

    if check_for_new_version(current_version, latest_version):
        print("There is a new version available!")
        print(f"Download it from: https://github.com/Tsuruta-Kurb/better-prompt/releases/tag/{latest_version}")

    while True:
        user_input = input("Better Prompt C:> ")

        if user_input.lower() == "exit":
            break

        elif user_input.lower() == "myip":
            print(get_computer_ip())
            print("")

        elif user_input.lower() == "wifipassword":
            wifi_info = get_connected_wifi_password()
            print(wifi_info)
            print("")

        elif user_input.lower() == "internetspeed":
            download_speed = check_internet_speed()
            print(f"Download speed: {download_speed:.2f} MBps")
            print("")

        else:
            try:
                result = subprocess.run(user_input, shell=True, text=True, capture_output=True)
                print(result.stdout)
                if result.stderr:
                    print(result.stderr)
            except subprocess.CalledProcessError as e:
                print("Error:", e)

if __name__ == "__main__":
    main()
